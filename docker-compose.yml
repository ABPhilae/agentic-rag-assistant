version: '3.9'

services:

  # ── 1. Vector Database ──────────────────────────────────────────
  qdrant:
    image: qdrant/qdrant:latest
    ports:
      - '6333:6333'
    volumes:
      - ./data/qdrant_storage:/qdrant/storage
    restart: unless-stopped

  # ── 2. Redis (LangGraph checkpointing) ─────────────────────────
  redis:
    image: redis:7-alpine
    ports:
      - '6379:6379'
    restart: unless-stopped
    command: redis-server --save 60 1 --loglevel warning

  # ── 3. NeMo Guardrails sidecar ─────────────────────────────────
  guardrails:
    build:
      context: .
      dockerfile: Dockerfile.guardrails
    ports:
      - '8080:8080'
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    restart: unless-stopped

  # ── 4. FastAPI Agent Backend ────────────────────────────────────
  api:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - '8000:8000'
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - LANGCHAIN_API_KEY=${LANGCHAIN_API_KEY}
      - LANGCHAIN_TRACING_V2=${LANGCHAIN_TRACING_V2}
      - LANGCHAIN_PROJECT=${LANGCHAIN_PROJECT}
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - REDIS_URL=redis://redis:6379
      - GUARDRAILS_URL=http://guardrails:8080
    depends_on:
      - qdrant
      - redis
      - guardrails
    restart: unless-stopped
    volumes:
      - ./src:/app/src   # Hot reload during development

  # ── 5. Streamlit Frontend ───────────────────────────────────────
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    ports:
      - '8501:8501'
    environment:
      - API_URL=http://api:8000
    depends_on:
      - api
    restart: unless-stopped
    volumes:
      - ./frontend:/app/frontend
